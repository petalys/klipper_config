# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v2.0. To use this config, the firmware should be compiled for the
# STM32F103 with a "28KiB bootloader" and USB communication. Also,
# select "Enable extra low-level configuration options" and configure
# "GPIO pins to set at micro-controller startup" to "!PA14".

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.
 
[neopixel neo]
pin: PA8
chain_count: 12
color_order: GRB
initial_RED: 0.0
initial_GREEN: .4


[led_effect progress_bar]
leds:
    neopixel:neo
autostart:                          true
frame_rate:                         24
layers:
    progress  -1  0 add         ( 0, .20,   0) 
    static     0  0 top         (0,0,.01)

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
	G1 X-9.000 Y20 F4200
	G1 X-9.000 Y0 F10000 
	G1 X-9.000 Y20 F10000
	G1 X-9.000 Y0 F10000
	progress_bar
	BASE_RESUME

 

[gcode_macro progress_bar]
gcode:
	STOP_LED_EFFECTS
	SET_LED_EFFECT EFFECT=progress_bar


[gcode_macro printer_pause]
gcode:
	STOP_LED_EFFECTS
	SET_LED_EFFECT EFFECT=printer_pause


[delayed_gcode printer_startup]
initial_duration: 5.
gcode:
  PRINTER_IDLE

 

[gcode_macro printer_warmup]
gcode:
	STOP_LED_EFFECTS
	SET_LED_EFFECT EFFECT=printer_warmup

[gcode_macro printer_idle]
gcode:
	STOP_LED_EFFECTS
	SET_LED_EFFECT EFFECT=printer_idle

[gcode_macro global]
variable_current_effect:'' 
gcode:  
    M115 ; must provide something
 

[led_effect printer_warmup]
autostart:              false
frame_rate:             24
leds:
    neopixel:neo 
layers:  
   		chase  .3 4 add   (0, 0.1, 0),(0, 0.1, 0) ,(.066,.033,0),(.066,.033,0) ,(0.1, 0, 0)  ,(0.1, 0, 0)  ,(0.1, 0, 0)   ,(0.1, 0, 0)  

[led_effect printer_idle]
autostart:              false
frame_rate:             24
leds:
    neopixel:neo 
layers:  
   		chase  .3 4 add   (0,0,.1),(0, 0.1, 0),(0,0,.1) 


[led_effect printer_pause]
autostart:              false
frame_rate:             24
leds:
    neopixel:neo 
layers:  
   		breathing  3 4 add    (.066, 0.033,0)
		   static 1 1 add (0, 0.1, 0) 
 
 

[mcu rpi]
serial: /tmp/klipper_host_mcu

[firmware_retraction]
retract_length: .2
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 30
#   The speed of retraction, in mm/s. The default is 20 mm/s.
#unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 30
#   The speed of unretraction, in mm/s. The default is 10 mm/s.


[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    120,110,20  # an example

[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 64
rotation_distance: 40
full_steps_per_rotation:400
endstop_pin: ^PC0
position_endstop: -40
position_min:-40
position_max: 210
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: .7
interpolate: False
#tealthchop_threshold: 999999
 

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 64
rotation_distance: 40
full_steps_per_rotation:400
endstop_pin: ^PC1
position_endstop: -28
position_min:-28
position_max: 200
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current:.7
interpolate: False
#stealthchop_threshold: 999999

[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 1
#position_endstop: 0.0                     # disable to use BLTouch
#endstop_pin: ^PA7                         # disable to use BLTouch
endstop_pin: probe:z_virtual_endstop  
position_max: 250
position_min: -5 
full_steps_per_rotation:400
rotation_distance: 8
homing_speed: 3

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 2
interpolate: True
#stealthchop_threshold: 999999

[extruder]
step_pin: PB3
dir_pin: !PB4
enable_pin: !PD2
microsteps:128
rotation_distance:8.0912 #8.067#8#7.968# 8.3
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: PC8
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 260
pressure_advance: 0.06
max_extrude_only_distance: 150.0
max_extrude_cross_section: 3#.25

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
run_current: .8
interpolate: False
#stealthchop_threshold: 999999

[heater_bed]
heater_pin: PC9
sensor_type:  EPCOS 100K B57560G104F
sensor_pin: PC3
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[heater_fan nozzle_cooling_fan]
pin: PC7

[fan]
pin: PC6

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_38FFD5055641343428791143-if00

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 400
#max_accel_to_decel : 7000
max_z_velocity: 3
max_z_accel: 100
square_corner_velocity:3

[input_shaper]
#shaper_freq_x: 48.2
#shaper_freq_y: 39.1
#shaper_type: ei

[static_digital_output usb_pullup_enable]
pins: !PA14

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PB5, EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PB15, EXP1_10=<5V>

[virtual_sdcard]
path: ~/gcode_files

[pause_resume] 

[display_status] 


[safe_z_home]         
home_xy_position: 120, 110
speed: 100
z_hop: 10
z_hop_speed: 2


[bltouch]              
sensor_pin: ^PC14
control_pin: PA1
x_offset: 0
y_offset: 24
#Z_offset: 5.4
probe_with_touch_mode: False
stow_on_each_sample : True
samples: 4
pin_move_time: 0.680
speed: 3.0
samples_result: median 
samples_tolerance: 0.005
samples_tolerance_retries: 10

[bed_mesh]                              
speed: 100
mesh_min: 10, 10
mesh_max: 180, 180
algorithm: bicubic
probe_count: 5,5
fade_start: 0
fade_end: 4
fade_target: 0
horizontal_move_z: 6

[screws_tilt_adjust]
screw1:24,-3
screw1_name: front left screw
screw2: 196, -3
screw2_name: front right screw
screw3: 196, 167
screw3_name: rear right screw
screw4: 24,167
screw4_name: rear left screw
horizontal_move_z: 6
speed: 50
screw_thread: CW-M3

[idle_timeout]
gcode:
     SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
    timeout: 600
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100



[gcode_macro GCODE_START]
gcode:
	PRINTER_WARMUP  
	M106 S255
	{% set BED_TEMP = params.BED_TEMP|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|float %}
	G90 ; use absolute coordinates
	M83 ; extruder relative mode
	M140 S{BED_TEMP} ; set final bed temp
	M104 S150 ; set temporary nozzle temp to prevent oozing during homing and auto bed leveling
	G4 S10 ; allow partial nozzle warmup
	G28 ; home all axisGCODE_)SATART;
	G1 Z50 F240
	G1 X2 Y10 F3000
	M104 S{EXTRUDER_TEMP} ; set final nozzle temp
	M190 S{BED_TEMP} ; wait for bed temp to stabilize
	M109 S{EXTRUDER_TEMP} ; wait for nozzle temp to stabilize
	G1 Z0.28 F240
	G92 E0
	G1 Y140 E10 F1500 ; prime the nozzle
	G1 X2.3 F5000
	G92 E0
	G1 Y10 E10 F1200 ; prime the nozzle
	G92 E0
	G21 ; set units to millimeters
	G90 ; use absolute coordinates
	M82
	G92 E0
	M107
	PROGRESS_BAR
	
[gcode_macro GCODE_END]
gcode:
	G91 ;Relative positioning
	G1 E-2 F2700 ;Retract a bit
	G1 E-2 Z0.2 F2400 ;Retract and raise Z
	G1 X5 Y5 F3000 ;Wipe out
	G1 Z10 ;Raise Z more
	G90 ;Absolute positionning

	G1 X0 Y200 ;Present print
	M106 S0 ;Turn-off fan
	M104 S0 ;Turn-off hotend
	M140 S0 ;Turn-off bed

	;M84 X Y E ;Disable all steppers but Z
	PRINTER_IDLE



[gcode_macro M600]
gcode:
    {% set X = printer.toolhead.axis_maximum.x|float - 5.0 %}
    {% set Y = printer.toolhead.axis_maximum.y|float - 5.0 %}
    {% set Z = params.Z|default(30)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91 
    RESTORE_GCODE_STATE NAME=M600_state
  
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
  TURN_OFF_HEATERS
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  BASE_CANCEL_PRINT


[gcode_macro MyHome] 
gcode:
  G28
  GET_POSITION


[gcode_macro START_PROBE_CALIBRATE]
gcode:
  G28
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=60
  M109 S200
  PROBE_CALIBRATE
  
[gcode_macro ACCEPT_PROBE_CALIBRATE]
gcode:
  ACCEPT

[gcode_macro ABORT_PROBE_CALIBRATE]
gcode:
  ABORT

[gcode_macro PROBE_UP_1]
gcode:
  TESTZ Z=1
  
[gcode_macro PROBE_UP_P1]
gcode:
  TESTZ Z=.1
 
[gcode_macro PROBE_DOWN_1]
gcode:
  TESTZ Z=-1
 
[gcode_macro PROBE_DOWN_P1]
gcode:
  TESTZ Z=-.1
   
[gcode_macro PROBE_PIN_DOWN]
gcode:
  BLTOUCH_DEBUG COMMAND=pin_down
   
[gcode_macro PROBE_PIN_UP]
gcode:
  BLTOUCH_DEBUG COMMAND=pin_up

 
[gcode_macro PROBE_PIN_RESET]
gcode:
  BLTOUCH_DEBUG COMMAND=pin_rest
 
  
[gcode_macro PROBE_PIN_ACCURACY]
gcode:
  PROBE_ACCURACY
  
[gcode_macro PROBE_SELF_TEST]
gcode:
  SELF_TEST

[gcode_macro Z_CYCLE5]
gcode:
  G90 
  G28 
  GET_POSITION
  G1 Z180 F7800
  G1 Z10 F7800
  G1 Z180 F7800
  G1 Z10 F7800
  G1 Z180 F7800
  G1 Z10 F7800
  G1 Z180 F7800
  G1 Z10 F7800
  G1 Z180 F7800
  G1 Z10 F7800
  SCREWS_TILT_CALCULATE 
  G28 
  GET_POSITION

[gcode_macro SCREWS_CYCLE]
gcode:
  G28
  GET_POSITION
  G1 Z100 F7800
  G28
  GET_POSITION
  SCREWS_TILT_CALCULATE

[gcode_macro MY_SCREWS_TILT_CALCULATE]
gcode:
  G28
  GET_POSITION  
  SCREWS_TILT_CALCULATE
   G1 Z50 F7800

# See the sample-lcd.cfg file for definitions of common LCD displays.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 29.532
#*# pid_ki = 2.734
#*# pid_kd = 79.736
#*#
#*# [bltouch]
#*# z_offset =0.300
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 42.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 33.2
